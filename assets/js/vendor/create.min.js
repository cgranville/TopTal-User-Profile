!function(t,e){t.widget("Midgard.midgardCreate",{options:{toolbar:"full",saveButton:null,state:"browse",highlight:!0,highlightColor:"#67cc08",editorWidgets:{"default":"hallo"},editorOptions:{hallo:{widget:"halloWidget"}},collectionWidgets:{"default":"midgardCollectionAdd"},url:function(){},storagePrefix:"node",workflows:{url:null},notifications:{},vie:null,stanbolUrl:null,dbPediaUrl:null,tags:!1},_create:function(){this.options.vie?this.vie=this.options.vie:(this.vie=new VIE,this.vie.use(new this.vie.RdfaService),this.options.stanbolUrl&&this.vie.use(new this.vie.StanbolService({proxyDisabled:!0,url:this.options.stanbolUrl})),this.options.dbPediaUrl&&this.vie.use(new this.vie.DBPediaService({proxyDisabled:!0,url:this.options.dbPediaUrl})));var t=this;window.setTimeout(function(){t._checkSession()},10),this._enableToolbar(),this._saveButton(),this._editButton(),this._prepareStorage(),this.element.midgardWorkflows&&this.element.midgardWorkflows(this.options.workflows),this.element.midgardNotifications&&this.element.midgardNotifications(this.options.notifications)},_prepareStorage:function(){this.element.midgardStorage({vie:this.vie,url:this.options.url}),this.element.bind("midgardstoragesave",function(){t("#midgardcreate-save a").html('Saving <i class="icon-upload"></i>')}),this.element.bind("midgardstoragesaved midgardstorageerror",function(){t("#midgardcreate-save a").html('Save <i class="icon-ok"></i>')})},_init:function(){this.setState(this.options.state)},setState:function(t){this._setOption("state",t),"edit"===t?this._enableEdit():this._disableEdit(),this._setEditButtonState(t)},showNotification:function(e){return this.element.midgardNotifications?t(this.element).data("midgardNotifications").create(e):void 0},configureEditor:function(t,e,i){this.options.editorOptions[t]={widget:e,options:i}},setEditorForContentType:function(t,i){if(this.options.editorOptions[i]===e&&null!==i)throw new Error("No editor "+i+" configured");this.options.editorWidgets[t]=i},setEditorForProperty:function(t,i){if(this.options.editorOptions[i]===e&&null!==i)throw new Error("No editor "+i+" configured");this.options.editorWidgets[t]=i},_checkSession:function(){if(Modernizr.sessionstorage){var t=this.options.storagePrefix+"Midgard.create.toolbar";sessionStorage.getItem(t)&&this._setOption("toolbar",sessionStorage.getItem(t));var e=this.options.storagePrefix+"Midgard.create.state";sessionStorage.getItem(e)&&this.setState(sessionStorage.getItem(e)),this.element.bind("midgardcreatestatechange",function(t,i){sessionStorage.setItem(e,i.state)})}},_saveButton:function(){return this.options.saveButton?this.options.saveButton:(t(".create-ui-toolbar-statustoolarea .create-ui-statustools",this.element).append(t('<li id="midgardcreate-save"><a class="create-ui-btn">Save <i class="icon-ok"></i></a></li>')),this.options.saveButton=t("#midgardcreate-save",this.element),this.options.saveButton.hide(),this.options.saveButton)},_editButton:function(){var e=this;t(".create-ui-toolbar-statustoolarea .create-ui-statustools",this.element).append(t('<li id="midgardcreate-edit"></li>')),t("#midgardcreate-edit",this.element).bind("click",function(){return"edit"===e.options.state?(e.setState("browse"),void 0):(e.setState("edit"),void 0)})},_setEditButtonState:function(e){var i={edit:'<a class="create-ui-btn">Cancel <i class="icon-remove"></i></a>',browse:'<a class="create-ui-btn">Edit <i class="icon-edit"></i></a>'},o=t("#midgardcreate-edit",this.element);o&&("edit"===e&&o.addClass("selected"),o.html(i[e]))},_enableToolbar:function(){var t=this;this.element.bind("midgardtoolbarstatechange",function(e,i){Modernizr.sessionstorage&&sessionStorage.setItem(t.options.storagePrefix+"Midgard.create.toolbar",i.display),t._setOption("toolbar",i.display)}),this.element.midgardToolbar({display:this.options.toolbar,vie:this.vie})},_enableEdit:function(){this._setOption("state","edit");var e=this,i={toolbarState:e.options.display,disabled:!1,vie:e.vie,widgets:e.options.editorWidgets,editors:e.options.editorOptions,collectionWidgets:e.options.collectionWidgets};e.options.enableEditor&&(i[enableEditor]=e.options.enableEditor),e.options.disableEditor&&(i[disableEditor]=e.options.disableEditor),t("[about]",this.element).each(function(){var o=this;if(e.options.highlight){var n=function(i,n){t(n.element).is(":visible")&&n.entityElement.get(0)===o&&n.element.effect("highlight",{color:e.options.highlightColor},3e3)};t(this).bind("midgardeditableenableproperty",n)}t(this).bind("midgardeditabledisable",function(){t(this).unbind("midgardeditableenableproperty",n)}),e.options.tags&&t(this).bind("midgardeditableenable",function(i,n){i.target===o&&t(this).midgardTags({vie:e.vie,entityElement:n.entityElement,entity:n.instance})}),t(this).midgardEditable(i)}),this._trigger("statechange",null,{state:"edit"})},_disableEdit:function(){var e=this,i={disabled:!0,vie:e.vie,editorOptions:e.options.editorOptions};t("[about]",this.element).each(function(){t(this).midgardEditable(i),t(this).removeClass("ui-state-disabled")}),this._setOption("state","browse"),this._trigger("statechange",null,{state:"browse"})}})}(jQuery),function(t){t.widget("Midgard.midgardCollectionAdd",{addButton:null,options:{editingWidgets:null,collection:null,model:null,view:null,disabled:!1,vie:null,editableOptions:null},_create:function(){var t=this;t.options.collection.localStorage||(t.options.collection.url=t.options.model.url()),t.options.view.collection.bind("add",function(e){e.primaryCollection=t.options.collection,t.options.vie.entities.add(e),e.collection=t.options.collection}),t._bindCollectionView(t.options.view)},_bindCollectionView:function(t){var e=this;t.bind("add",function(t){e._makeEditable(t)})},_makeEditable:function(e){this.options.editableOptions.disabled=this.options.disabled,this.options.editableOptions.model=e.model,t(e.el).midgardEditable(this.options.editableOptions)},_init:function(){return this.options.disabled?(this.disable(),void 0):(this.enable(),void 0)},enable:function(){var e=this;e.addButton=t('<button class="btn"><i class="icon-plus"></i> Add</button>').button(),e.addButton.addClass("midgard-create-add"),e.addButton.click(function(){e.options.collection.add({})}),t(e.options.view.el).after(e.addButton)},disable:function(){this.addButton&&(this.addButton.remove(),delete this.addButton)}})}(jQuery),function(t){t.widget("Midgard.midgardCollectionAddBetween",t.Midgard.midgardCollectionAdd,{addButtons:[],_bindCollectionView:function(t){var e=this;t.bind("add",function(t){e._makeEditable(t),e._refreshButtons()}),t.bind("remove",function(){e._refreshButtons()})},_refreshButtons:function(){var t=this;window.setTimeout(function(){t.disable(),t.enable()},1)},prepareButton:function(e){var i=this,o=t('<button class="btn"><i class="icon-plus"></i></button>').button();return o.addClass("midgard-create-add"),o.click(function(){i.options.collection.add({},{at:e})}),o},enable:function(){var e=this,i=e.prepareButton(0);t(e.options.view.el).before(i),e.addButtons.push(i),t.each(e.options.view.entityViews,function(i,o){var n=e.options.collection.indexOf(o.model),a=e.prepareButton(n+1);t(o.el).after(a),e.addButtons.push(a)})},disable:function(){var e=this;t.each(e.addButtons,function(t,e){e.remove()}),e.addButtons=[]}})}(jQuery),function(t,e){t.widget("Midgard.midgardEditable",{options:{editables:[],collections:[],model:null,editors:{hallo:{widget:"halloWidget",options:{}}},widgets:{"default":"hallo"},collectionWidgets:{"default":"midgardCollectionAdd"},toolbarState:"full",vie:null,disabled:!1},_create:function(){if(this.vie=this.options.vie,!this.options.model){var t=this;this.vie.load({element:this.element}).from("rdfa").execute().done(function(e){t.options.model=e[0]})}},_init:function(){return this.options.disabled?(this.disable(),void 0):(this.enable(),void 0)},enable:function(){var e=this;this.options.model&&(this.vie.service("rdfa").findPredicateElements(this.options.model.id,t("[property]",this.element),!1).each(function(){return e._enableProperty(t(this))}),this._trigger("enable",null,{instance:this.options.model,entityElement:this.element}),_.forEach(this.vie.service("rdfa").views,function(i){if(i instanceof e.vie.view.Collection&&e.options.model===i.owner){var o=e.enableCollection({model:e.options.model,collection:i.collection,property:t(i.el).attr("rel"),view:i,element:i.el,vie:e.vie,editableOptions:e.options});e.options.collections.push(o)}}))},disable:function(){var e=this;t.each(this.options.editables,function(i,o){e.disableEditor({widget:e,editable:o,entity:e.options.model,element:t(this)})}),this.options.editables=[],t.each(this.options.collections,function(t,i){e.disableCollection({widget:e,model:e.options.model,element:i,vie:e.vie,editableOptions:e.options})}),this.options.collections=[],this._trigger("disable",null,{instance:this.options.model,entityElement:this.element})},_enableProperty:function(t){var e=this,i=this.vie.service("rdfa").getElementPredicate(t);if(!i)return!0;if(this.options.model.get(i)instanceof Array)return!0;var o=this.enableEditor({widget:this,element:t,entity:this.options.model,property:i,vie:this.vie,modified:function(o){var n={};n[i]=o,e.options.model.set(n,{silent:!0}),e._trigger("changed",null,{property:i,instance:e.options.model,element:t,entityElement:e.element})},activated:function(){e._trigger("activated",null,{property:i,instance:e.options.model,element:t,entityElement:e.element})},deactivated:function(){e._trigger("deactivated",null,{property:i,instance:e.options.model,element:t,entityElement:e.element})}});o&&this._trigger("enableproperty",null,{editable:o,property:i,instance:this.options.model,element:t,entityElement:this.element}),this.options.editables.push(o)},_editorName:function(t){if(this.options.widgets[t.property]!==e)return this.options.widgets[t.property];var i="default",o=this.options.model.get("@type");return o&&o.attributes&&o.attributes.get(t.property)&&(i=o.attributes.get(t.property).range[0]),this.options.widgets[i]!==e?this.options.widgets[i]:this.options.widgets["default"]},_editorWidget:function(t){return this.options.editors[t].widget},_editorOptions:function(t){return this.options.editors[t].options},enableEditor:function(e){var i=this._editorName(e);if(null!==i){var o=this._editorWidget(i);if(e.editorOptions=this._editorOptions(i),e.disabled=!1,"function"!=typeof t(e.element)[o])throw new Error(widgetName+" widget is not available");return t(e.element)[o](e),t(e.element).data("createWidgetName",o),t(e.element)}},disableEditor:function(e){var i=t(e.element).data("createWidgetName");e.disabled=!0,i&&(t(e.element)[i](e),t(e.element).removeClass("ui-state-disabled"))},collectionWidgetName:function(t){if(this.options.collectionWidgets[t.property]!==e)return this.options.collectionWidgets[t.property];var i="default",o=this.options.model.get("@type");return o&&o.attributes&&o.attributes.get(t.property)&&(i=o.attributes.get(t.property).range[0]),this.options.collectionWidgets[i]!==e?this.options.collectionWidgets[i]:void 0},enableCollection:function(e){var i=this.collectionWidgetName(e);if(null!==i){if(e.disabled=!1,"function"!=typeof t(e.element)[i])throw new Error(i+" widget is not available");return t(e.element)[i](e),t(e.element).data("createCollectionWidgetName",i),t(e.element)}},disableCollection:function(e){var i=t(e.element).data("createCollectionWidgetName");null!==i&&(e.disabled=!0,i&&(t(e.element)[i](e),t(e.element).removeClass("ui-state-disabled")))}})}(jQuery),function(t){t.widget("Create.editWidget",{options:{disabled:!1,vie:null},enable:function(){this.element.attr("contenteditable","true")},disable:function(){this.element.attr("contenteditable","false")},_create:function(){this._registerWidget(),this._initialize()},_init:function(){return this.options.disabled?(this.disable(),void 0):(this.enable(),void 0)},_initialize:function(){var e=this,i=this.element.html();this.element.bind("blur keyup paste",function(){if(!e.options.disabled){var o=t(this).html();i!==o&&(i=o,e.options.modified(o))}})},_registerWidget:function(){this.element.data("createWidgetName",this.widgetName)}})}(jQuery),function(t){t.widget("Create.alohaWidget",t.Create.editWidget,{enable:function(){this._initialize(),this.options.disabled=!1},disable:function(){Aloha.jQuery(this.options.element.get(0)).mahalo(),this.options.disabled=!0},_initialize:function(){var t,e=this.options,i=Aloha.jQuery(e.element.get(0)).aloha();_.each(Aloha.editables,function(e){e.obj.get(0)===i.get(0)&&(t=e)}),t&&(t.vieEntity=e.entity,Aloha.bind("aloha-editable-activated",function(i,o){o.editable===t&&e.activated()}),Aloha.bind("aloha-editable-deactivated",function(i,o){o.editable===t&&e.deactivated()}),Aloha.bind("aloha-smart-content-changed",function(i,o){if(o.editable===t){if(!o.editable.isModified())return!0;e.modified(o.editable.getContents()),o.editable.setUnmodified()}}))}})}(jQuery),function(t){t.widget("Create.halloWidget",t.Create.editWidget,{options:{editorOptions:{},disabled:!0,toolbarState:"full",vie:null,entity:null},enable:function(){t(this.element).hallo({editable:!0}),this.options.disabled=!1},disable:function(){t(this.element).hallo({editable:!1}),this.options.disabled=!0},_initialize:function(){t(this.element).hallo(this.getHalloOptions());var e=this;t(this.element).bind("halloactivated",function(){e.options.activated()}),t(this.element).bind("hallodeactivated",function(){e.options.deactivated()}),t(this.element).bind("hallomodified",function(t,i){e.options.modified(i.content),i.editable.setUnmodified()}),t(document).bind("midgardtoolbarstatechange",function(i,o){o.display!==e.options.toolbarState&&(e.options.toolbarState=o.display,t(e.element).hallo(e.getHalloOptions()))})},getHalloOptions:function(){var e={plugins:{halloformat:{},halloblock:{},hallolists:{},hallolink:{},halloimage:{entity:this.options.entity},halloindicator:{}},buttonCssClass:"create-ui-btn-small",placeholder:"["+this.options.property+"]"};return"function"==typeof this.element.annotate&&this.options.vie.services.stanbol&&(e.plugins.halloannotate={vie:this.options.vie}),"full"===this.options.toolbarState?(e.parentElement=t(".create-ui-toolbar-dynamictoolarea .create-ui-tool-freearea"),e.toolbar="halloToolbarFixed"):(e.showAlways=!1,e.toolbar="halloToolbarContextual"),_.extend(e,this.options.editorOptions)}})}(jQuery),function(t){t.widget("Create.redactorWidget",t.Create.editWidget,{editor:null,options:{editorOptions:{},disabled:!0},enable:function(){t(this.element).redactor(this.getRedactorOptions()),this.options.disabled=!1},disable:function(){t(this.element).destroyEditor(),this.options.disabled=!0},_initialize:function(){var e=this;t(this.element).bind("focus",function(){e.options.activated()})},getRedactorOptions:function(){var e=this,i={keyupCallback:function(){e.options.modified(t(e.element).getCode())},execCommandCallback:function(){e.options.modified(t(e.element).getCode())}};return _.extend(e.options.editorOptions,i)}})}(jQuery),function(t){var e=[],i=function(i,o){var n={class_prefix:"midgardNotifications",timeout:3e3,auto_show:!0,body:"",bindTo:null,gravity:"T",effects:{onShow:function(t,e){t.animate({opacity:"show"},600,e)},onHide:function(t,e){t.animate({opacity:"hide"},600,e)}},actions:[],callbacks:{}},a={},s={},r=null,l=null,d=null,c=i,u=null,h={constructor:function(t){a=_.extend(n,t||{}),s={container:a.class_prefix+"-container",item:{wrapper:a.class_prefix+"-item",arrow:a.class_prefix+"-arrow",disregard:a.class_prefix+"-disregard",content:a.class_prefix+"-content",actions:a.class_prefix+"-actions",action:a.class_prefix+"-action"}},this._generate()},getId:function(){return l},getElement:function(){return r},_generate:function(){var i,o,n=this,d=null;if(r=i=t('<div class="'+s.item.wrapper+'-outer"/>'),i.css({display:"none"}),o=t('<div class="'+s.item.wrapper+'-inner"/>'),o.appendTo(i),a.bindTo){i.addClass(s.item.wrapper+"-binded");var h=t('<div class="'+s.item.arrow+'"/>');h.appendTo(i)}else i.addClass(s.item.wrapper+"-normal");if(d=t('<div class="'+s.item.content+'"/>'),d.html(a.body),d.appendTo(o),a.actions.length){var f=t('<div class="'+s.item.actions+'"/>');f.appendTo(o),t.each(a.actions,function(e,i){var o=t('<button name="'+i.name+'" class="button-'+i.name+'">'+i.label+"</button>").button();o.bind("click",function(t){u?i.cb(t,u,n):i.cb(t,n)}),i.className&&o.addClass(i.className),f.append(o)})}r.bind("click",function(t){a.callbacks.onClick?a.callbacks.onClick(t,n):u||n.close()}),a.auto_show&&this.show(),this._setPosition(),l=e.push(this),c.append(r)},_calculatePositionForGravity:function(t,e,i,o){switch(t.find("."+s.item.arrow).addClass(s.item.arrow+"_"+e),e){case"TL":return{left:i.left,top:i.top+i.height+"px"};case"TR":return{left:i.left+i.width-o.width+"px",top:i.top+i.height+"px"};case"BL":return{left:i.left+"px",top:i.top-o.height+"px"};case"BR":return{left:i.left+i.width-o.width+"px",top:i.top-o.height+"px"};case"LT":return{left:i.left+i.width+"px",top:i.top+"px"};case"LB":return{left:i.left+i.width+"px",top:i.top+i.height-o.height+"px"};case"RT":return{left:i.left-o.width+"px",top:i.top+"px"};case"RB":return{left:i.left-o.width+"px",top:i.top+i.height-o.height+"px"};case"T":return{left:i.left+i.width/2-o.width/2+"px",top:i.top+i.height+"px"};case"R":return{left:i.left-o.width+"px",top:i.top+i.height/2-o.height/2+"px"};case"B":return{left:i.left+i.width/2-o.width/2+"px",top:i.top-o.height+"px"};case"L":return{left:i.left+i.width+"px",top:i.top+i.height/2-o.height/2+"px"}}},_isFixed:function(t){return t===document?!1:"fixed"===t.css("position")?!0:this._isFixed(t.offsetParent())},_setPosition:function(){if(a.bindTo){itemDimensions={width:r.width()?r.width():280,height:r.height()?r.height():109},d=t(a.bindTo);var i={},o={width:d.outerWidth(),height:d.outerHeight()};this._isFixed(d)?(i.position="fixed",o.left=d.offset().left,o.top=d.position().top):(i.position="absolute",o.left=d.offset().left,o.top=d.offset().top);var n=this._calculatePositionForGravity(r,a.gravity,o,itemDimensions);return i.top=n.top,i.left=n.left,r.css(i),void 0}a.position||(a.position="top right");var s=t(".create-ui-toolbar-wrapper").outerHeight(!0)+6;n={position:"fixed"};var l=function(e){var i=0;return t.each(e,function(t,e){e&&(i+=e.getElement().height())}),i};a.position.match(/top/)&&(n.top=s+l(e)+"px"),a.position.match(/bottom/)&&(n.bottom=e.length-1*item.height()+item.height()+10+"px"),a.position.match(/right/)&&(n.right="20px"),a.position.match(/left/)&&(n.left="20px"),r.css(n)},show:function(){var e,i,o,n,s,l,d=this;if(a.callbacks.beforeShow&&a.callbacks.beforeShow(d),a.bindTo){var c=t(a.bindTo);e=t(window).scrollTop(),i=t(window).scrollTop()+t(window).height(),n=parseFloat(r.offset().top,10),s=c.offset().top,l=c.outerHeight(),n>s&&(n=s),o=parseFloat(r.offset().top,10)+r.height(),s+l>o&&(o=s+l)}a.timeout>0&&!a.actions.length&&setTimeout(function(){d.close()},a.timeout),a.bindTo&&(e>n||n>i)||e>o||o>i?t("html, body").stop().animate({scrollTop:n},500,"easeInOutExpo",function(){a.effects.onShow(r,function(){a.callbacks.afterShow&&a.callbacks.afterShow(d)})}):a.effects.onShow(r,function(){a.callbacks.afterShow&&a.callbacks.afterShow(d)})},close:function(){var t=this;a.callbacks.beforeClose&&a.callbacks.beforeClose(t),a.effects.onHide(r,function(){a.callbacks.afterClose&&a.callbacks.afterClose(t),t.destroy()})},destroy:function(){var i=this;t.each(e,function(t,o){o&&o.getId()==i.getId()&&delete e[t]}),t(r).remove()},setStory:function(t){u=t},setName:function(t){r.addClass(s.item.wrapper+"-custom-"+t),this.name=t}};return h.constructor(o),delete h.constructor,h},o=function(e,o){var n={},a={},s={},r=null,l=null,d=null,c={constructor:function(t){a=_.extend(n,t||{})},setStoryline:function(e){var i={content:"",actions:[],show_actions:!0,notification:{},back:null,back_label:null,forward:null,forward_label:null,beforeShow:null,afterShow:null,beforeClose:null,afterClose:null};s={},_current_item=null,r=null,l=null,d=null;var o=this;return t.each(e,function(e,n){var a=t.extend({},i,n);a.name=e;var c=t.extend({},i.notification,n.notification||{});c.body=a.content,c.auto_show=!1,a.actions.length&&(c.delay=0),c.callbacks={beforeShow:function(t){a.beforeShow&&a.beforeShow(t,o)},afterShow:function(t){a.afterShow&&a.afterShow(t,o)},beforeClose:function(t){a.beforeClose&&a.beforeClose(t,o)},afterClose:function(t){a.afterClose&&a.afterClose(t,o),r=t.name}},c.actions=[],a.show_actions&&(a.back&&(back_label=a.back_label,back_label||(back_label="Back"),c.actions.push({name:"back",label:back_label,cb:function(t,e){e.previous()}})),a.forward&&(forward_label=a.forward_label,forward_label||(forward_label="Back"),c.actions.push({name:"forward",label:forward_label,cb:function(t,e){e.next()}})),a.actions.length&&t.each(a.actions,function(t){c.actions.push(a.actions[t])})),l||(l=e),d=e,a.notification=c,s[e]=a}),s},start:function(){this._showNotification(s[l])},stop:function(){_current_item.close(),_current_item=null,r=null},next:function(){_current_item.close(),s[_current_item.name].forward?(next_item=s[_current_item.name].forward,this._showNotification(s[next_item])):this._showNotification(s[d])},previous:function(){r?(_current_item.close(),s[_current_item.name].back?(prev_item=s[_current_item.name].back,this._showNotification(s[prev_item])):this._showNotification(s[r])):this.stop()},_showNotification:function(e){return _current_item=new i(t("body"),e.notification),_current_item.setStory(this),_current_item.setName(e.name),_current_item.show(),_current_item}};return c.constructor(e),delete c.constructor,o&&c.setStoryline(o),c},n={start:{content:"Welcome to CreateJS tutorial!",forward:"toolbar_toggle",forward_label:"Start tutorial",actions:[{name:"quit",label:"Quit",cb:function(t,e){e.stop()}}]},toolbar_toggle:{content:"This is the CreateJS toolbars toggle button.<br />You can hide and show the full toolbar by clicking here.<br />Try it now.",forward:"edit_button",show_actions:!1,afterShow:function(e,i){t("body").bind("midgardtoolbarstatechange",function(e,o){"full"==o.display&&(i.next(),t("body").unbind("midgardtoolbarstatechange"))})},notification:{bindTo:"#midgard-bar-hidebutton",timeout:0,gravity:"TL"}},edit_button:{content:"This is the edit button.<br />Try it now.",show_actions:!1,afterShow:function(e,i){t("body").bind("midgardcreatestatechange",function(e,o){"edit"==o.state&&(i.next(),t("body").unbind("midgardcreatestatechange"))})},notification:{bindTo:".ui-button[for=midgardcreate-edit]",timeout:0,gravity:"TL"}},end:{content:"Thank you for watching!<br />Happy content editing times await you!"}};t.widget("Midgard.midgardNotifications",{options:{notification_defaults:{class_prefix:"midgardNotifications",position:"top right"}},_create:function(){this.classes={container:this.options.notification_defaults.class_prefix+"-container"},t("."+this.classes.container,this.element).length?(this.container=t("."+this.classes.container,this.element),this._parseFromDOM()):(this.container=t('<div class="'+this.classes.container+'" />'),this.element.append(this.container))},destroy:function(){this.container.remove(),t.Widget.prototype.destroy.call(this)},_init:function(){},_parseFromDOM:function(){},showStory:function(t,e){var i=new o(t,e);return i.start(),i},create:function(e){return e=t.extend({},this.options.notification_defaults,e||{}),item=new i(this.container,e),item.show(),item},showTutorial:function(){this.showStory({},n)}})}(jQuery),function(t){t.widget("Midgard.midgardStorage",{changedModels:[],saveEnabled:!0,options:{localStorage:!1,removeLocalstorageOnIgnore:!0,vie:null,url:"",autoSave:!1,autoSaveInterval:5e3,saveReferencedNew:!1,saveReferencedChanged:!1},_create:function(){var e=this;Modernizr.localstorage&&(this.options.localStorage=!0),this.vie=this.options.vie,this.vie.entities.bind("add",function(t){t.url=e.options.url,t.toJSON=t.toJSONLD}),t("#midgardcreate-save").click(function(){e._saveRemote({success:function(){t("#midgardcreate-save").button({disabled:!0})},error:function(){}})}),e._bindEditables(),e.options.autoSave&&e._autoSave()},_autoSave:function(){var e=this;e.saveEnabled=!0;var i=function(){e.saveEnabled&&0!==e.changedModels.length&&e._saveRemote({success:function(){t("#midgardcreate-save").button({disabled:!0})},error:function(){}})},o=window.setInterval(i,e.options.autoSaveInterval);this.element.bind("startPreventSave",function(){o&&(window.clearInterval(o),o=null),e.disableSave()}),this.element.bind("stopPreventSave",function(){o||(o=window.setInterval(i,e.options.autoSaveInterval)),e.enableSave()})},enableSave:function(){this.saveEnabled=!0},disableSave:function(){this.saveEnabled=!1},_bindEditables:function(){var e,i=this,o=[];i.element.bind("midgardeditablechanged",function(e,o){-1===_.indexOf(i.changedModels,o.instance)&&i.changedModels.push(o.instance),i._saveLocal(o.instance),t("#midgardcreate-save").button({disabled:!1})}),i.element.bind("midgardeditabledisable",function(e,o){i._restoreLocal(o.instance),t("#midgardcreate-save").hide()}),i.element.bind("midgardeditableenable",function(e,n){t("#midgardcreate-save").button({disabled:!0}),t("#midgardcreate-save").show(),n.instance._originalAttributes||(n.instance._originalAttributes=_.clone(n.instance.attributes)),!n.instance.isNew()&&i._checkLocal(n.instance)&&o.push(n.instance)}),i.element.bind("midgardcreatestatechange",function(n,a){return"browse"===a.state||0===o.length?(o=[],e&&e.close(),void 0):(e=t("body").data("midgardCreate").showNotification({bindTo:"#midgardcreate-edit a",gravity:"TR",body:o.length+" items on this page have local modifications",timeout:0,actions:[{name:"restore",label:"Restore",cb:function(){_.each(o,function(t){i._readLocal(t)}),o=[],e=null},className:"create-ui-btn"},{name:"ignore",label:"Ignore",cb:function(t,n){i.options.removeLocalstorageOnIgnore&&_.each(o,function(t){i._removeLocal(t)}),n.close(),o=[],e=null},className:"create-ui-btn"}]}),void 0)}),i.element.bind("midgardstorageloaded",function(e,o){-1===_.indexOf(i.changedModels,o.instance)&&i.changedModels.push(o.instance),t("#midgardcreate-save").button({disabled:!1})})},_saveRemote:function(e){var i=this;if(0!==i.changedModels.length){i._trigger("save",null,{models:i.changedModels});var o=i.changedModels.length;o>1?notification_msg=o+" objects saved successfully":(subject=i.changedModels[0].getSubjectUri(),notification_msg="Object with subject "+subject+" saved successfully"),i.disableSave(),_.forEach(i.changedModels,function(n,a){_.each(n.attributes,function(t){t&&t.isCollection&&t.each(function(t){return-1===i.changedModels.indexOf(t)?t.isNew()&&i.options.saveReferencedNew?t.save():t.hasChanged()&&i.options.saveReferencedChanged?t.save():void 0:void 0})}),n.save(null,{success:function(){n._originalAttributes=_.clone(n.attributes),i._removeLocal(n),i.changedModels.splice(a,1),o--,0>=o&&(i._trigger("saved",null,{}),e.success(),t("body").data("midgardCreate").showNotification({body:notification_msg}),i.enableSave())},error:function(o,a){notification_msg="Error occurred while saving",a.responseText&&(notification_msg=notification_msg+":<br />"+a.responseText),e.error(),t("body").data("midgardCreate").showNotification({body:notification_msg}),i._trigger("error",null,{instance:n})}})})}},_saveLocal:function(t){if(this.options.localStorage){if(t.isNew()){if(!t.primaryCollection)return;return this._saveLocalReferences(t.primaryCollection.subject,t.primaryCollection.predicate,t)}localStorage.setItem(t.getSubjectUri(),JSON.stringify(t.toJSONLD()))}},_getReferenceId:function(t,e){return t.id+":"+e},_saveLocalReferences:function(t,e,i){if(this.options.localStorage&&t&&e){var o=t+":"+e,n=i.toJSONLD();if(localStorage.getItem(o)){var a=JSON.parse(localStorage.getItem(o)),s=_.pluck(a,"@").indexOf(n["@"]);return-1!==s?a[s]=n:a.push(n),localStorage.setItem(o,JSON.stringify(a)),void 0}localStorage.setItem(o,JSON.stringify([n]))}},_checkLocal:function(t){if(!this.options.localStorage)return!1;var e=localStorage.getItem(t.getSubjectUri());return e?!0:!1},_readLocal:function(t){if(this.options.localStorage){var e=localStorage.getItem(t.getSubjectUri());if(e){t._originalAttributes||(t._originalAttributes=_.clone(t.attributes));var i=JSON.parse(e),o=this.vie.entities.addOrUpdate(i,{overrideAttributes:!0});this._trigger("loaded",null,{instance:o})}}},_readLocalReferences:function(t,e,i){if(this.options.localStorage){var o=this._getReferenceId(t,e),n=localStorage.getItem(o);n&&i.add(JSON.parse(n))}},_restoreLocal:function(e){var i=this;if(e)return _.each(e.attributes,function(t){t instanceof i.vie.Collection&&t.forEach(function(e){e.isNew()&&t.remove(e)})}),t.isEmptyObject(e.changedAttributes())?(e._originalAttributes&&e.set(e._originalAttributes),void 0):(e.set(e.previousAttributes()),void 0)},_removeLocal:function(t){this.options.localStorage&&localStorage.removeItem(t.getSubjectUri())}})}(jQuery),function(t,e){t.widget("Midgard.midgardTags",{enhanced:!1,options:{vie:null,entity:null,element:null,entityElement:null,parentElement:".create-ui-tool-metadataarea",predicate:"skos:related"},_init:function(){var e=this;this.vie=this.options.vie,this.entity=this.options.entity,this.element=this.options.element,t(this.options.entityElement).bind("midgardeditableactivated",function(t,i){i.instance===e.options.entity&&(e._renderWidget(),e.loadTags())}),t(this.options.entityElement).bind("midgardeditablechanged",function(t,i){i.instance===e.options.entity&&(e.enhanced=!1)}),this._listenAnnotate(this.options.entityElement)},_normalizeSubject:function(t){return this.entity.isReference(t)?t:("http://"!==t.substr(0,7)&&(t="urn:tag:"+t),t=this.entity.toReference(t))},_tagLabel:function(t){return t=this.entity.fromReference(t),"urn:tag:"===t.substr(0,8)&&(t=t.substr(8,t.length-1)),"http://"==t.substring(0,7)&&(t=t.substr(t.lastIndexOf("/")+1,t.length-1),t=t.replace(/_/g," ")),t},addTag:function(t,i,o){i===e&&(i=this._tagLabel(t)),t=this._normalizeSubject(t),o&&!this.entity.isReference(o)&&(o=this.entity.toReference(o));var n=this.vie.entities.addOrUpdate({"@subject":t,"rdfs:label":i,"@type":o}),a=this.options.entity.get(this.options.predicate);a?a.isCollection||(a=new this.vie.Collection(_.map(a,function(t){return t.isEntity?t:{"@subject":t}})),a.vie=this.options.vie,this.options.entity.set(this.options.predicate,a)):(a=new this.vie.Collection,a.vie=this.options.vie,this.options.entity.set(this.options.predicate,a)),a.addOrUpdate(n),this.options.entityElement.trigger("midgardeditablechanged",{instance:this.options.entity})},removeTag:function(t){var e=this.options.entity.get(this.options.predicate);if(e){t=this._normalizeSubject(t);var i=e.get(t);i&&(e.remove(t),this.options.entityElement.trigger("midgardeditablechanged",{instance:this.options.entity}))}},_listenAnnotate:function(t){var e=this;t.bind("annotateselect",function(t,i){e.addTag(i.linkedEntity.uri,i.linkedEntity.label,i.linkedEntity.type[0])}),t.bind("annotateremove",function(t,i){e.removeTag(i.linkedEntity.uri)})},_prepareEditor:function(e){var i=t('<div class="dropdown-menu"></div>'),o=t('<div class="create-ui-tags articleTags"><h3>Article tags</h3><input type="text" class="tags" value="" /></div>'),n=t('<div class="create-ui-tags suggestedTags"><h3>Suggested tags</h3><input type="text" class="tags" value="" /></div>');t("input",o).attr("id","articleTags-"+this.entity.cid),t("input",n).attr("id","suggestedTags-"+this.entity.cid),i.append(o),i.append(n),i.hide();var a=e.position();return i.css("position","absolute"),i.css("left",a.left),i},_renderWidget:function(){var e=this,i=(this.entity.getSubject(),t('<button class="create-ui-btn"><i class="icon-tags"></i> Tags</a>').button()),o=t(this.options.parentElement);o.empty(),o.append(i),o.show();var n=this._prepareEditor(i);i.after(n),this.articleTags=t(".articleTags input",n).tagsInput({width:"auto",height:"auto",onAddTag:function(t){e.addTag(t)},onRemoveTag:function(t){e.removeTag(t)}});var a=function(){var i=t.trim(t(this).text());e.articleTags.addTag(i),e.suggestedTags.removeTag(i)};this.suggestedTags=t(".suggestedTags input",n).tagsInput({width:"auto",height:"auto",interactive:!1,onAddTag:function(){t(".suggestedTags .tag span",n).unbind("click",a),t(".suggestedTags .tag span",n).bind("click",a)
},onRemoveTag:function(){t(".suggestedTags .tag span",n).unbind("click",a),t(".suggestedTags .tag span",n).bind("click",a)},remove:!1}),i.bind("click",function(){n.toggle()})},loadTags:function(){var e=this,i=this.entity.get(this.options.predicate);i&&(_.isString(i)?e.articleTags.addTag(e._tagLabel(i)):i.isCollection?i.each(function(t){e.articleTags.addTag(t.get("rdfs:label"))}):_.each(i,function(t){e.articleTags.addTag(e._tagLabel(t))})),this.vie.services.stanbol?e.enhance():t(".suggestedTags",e.element).hide()},_getLabelLang:function(t){if(!_.isArray(t))return null;var e;return _.each(t,function(t){"en"===t["@language"]&&(e=t["@value"])}),e},_addEnhancement:function(t){if(t.isEntity){var e=this._getLabelLang(t.get("rdfs:label"));if(e){var i=this.options.entity.get(this.options.predicate);i&&i.isCollection&&-1!==i.indexOf(t)||this.suggestedTags.addTag(e)}}},enhance:function(){if(!this.enhanced){this.enhanced=!0;var e=this;this.vie.analyze({element:t("[property]",this.options.entityElement)}).using(["stanbol"]).execute().success(function(t){_.each(t,function(t){e._addEnhancement(t)})}).fail(function(){})}}})}(jQuery),function(t){t.widget("Midgard.midgardToolbar",{options:{display:"full"},_create:function(){this.element.append(this._getMinimized()),this.element.append(this._getFull());var e=this;t(".create-ui-toggle").click(function(){"full"===e.options.display?(e.hide(),e.options.display="minimized"):(e.show(),e.options.display="full"),e._trigger("statechange",null,e.options)}),this._setDisplay(this.options.display),e=this,t(this.element).bind("midgardcreatestatechange",function(t,i){"browse"==i.state&&(e._clearWorkflows(),e._clearMetadata())}),t(this.element).bind("midgardworkflowschanged",function(i,o){e._clearWorkflows(),o.workflows.length&&o.workflows.each(function(i){html=t("body").data().midgardWorkflows.prepareItem(o.instance,i,function(t){e._clearWorkflows(),t}),t(".create-ui-tool-workflowarea",this.element).append(html)})})},_setOption:function(t,e){"display"===t&&this._setDisplay(e),this.options[t]=e},_setDisplay:function(e){"minimized"===e&&t("div.create-ui-toolbar-wrapper").hide()},hide:function(){t("div.create-ui-toolbar-wrapper").fadeToggle("fast","linear")},show:function(){t("div.create-ui-toolbar-wrapper").fadeToggle("fast","linear")},_getMinimized:function(){return t('<div class="create-ui-logo"><a class="create-ui-toggle" id="create-ui-toggle-toolbar"></a></div>')},_getFull:function(){return t('<div class="create-ui-toolbar-wrapper"><div class="create-ui-toolbar-toolarea"><div class="create-ui-toolbar-dynamictoolarea"><ul class="create-ui-dynamictools create-ui-toolset-1"><li class="create-ui-tool-metadataarea"></li><li class="create-ui-tool-workflowarea"></li><li class="create-ui-tool-freearea"></li></ul></div><div class="create-ui-toolbar-statustoolarea"><ul class="create-ui-statustools"></ul></div></div></div>')},_clearWorkflows:function(){t(".create-ui-tool-workflowarea",this.element).empty()},_clearMetadata:function(){t(".create-ui-tool-metadataarea",this.element).empty()}})}(jQuery),function(t){t.widget("Midgard.midgardWorkflows",{options:{url:function(){},renderers:{button:function(e,i,o,n){return button_id="midgardcreate-workflow_"+i.get("name"),html=t('<button class="create-ui-btn" id="'+button_id+'">'+i.get("label")+"</button>").button(),html.bind("click",function(){o(e,i,n)}),html}},action_types:{backbone_save:function(t,e,i){copy_of_url=t.url,original_model=t.clone(),original_model.url=copy_of_url,action=e.get("action"),action.url&&(t.url=action.url),original_model.save(null,{success:function(){t.url=copy_of_url,t.change(),i(null,t)},error:function(e,o){t.url=copy_of_url,t.change(),i(o,t)}})},backbone_destroy:function(t,e,i){copy_of_url=t.url,original_model=t.clone(),original_model.url=copy_of_url,action=e.get("action"),action.url&&(t.url=action.url),t.destroy({success:function(e){t.url=copy_of_url,t.change(),i(null,e)},error:function(e,o){t.url=copy_of_url,t.change(),i(o,t)}})},http:function(e,i,o){return action=i.get("action"),action.url?(wf_opts={},action.http&&(wf_opts=action.http),ajax_options=t.extend({url:action.url,type:"POST",data:e.toJSON(),success:function(){e.fetch({success:function(t){o(null,t)},error:function(t,e){o(e,t)}})}},wf_opts),t.ajax(ajax_options),void 0):o("No action url defined!")}}},_init:function(){this._renderers={},this._action_types={},this._parseRenderersAndTypes(),this._last_instance=null,this.ModelWorkflowModel=Backbone.Model.extend({defaults:{name:"",label:"",type:"button",action:{type:"backbone_save"}}}),this.workflows={};var e=this;t(this.element).bind("midgardeditableactivated",function(t,i){e._fetchWorkflows(i.instance)})},_fetchWorkflows:function(t){var e=this;return t.isNew()?(e._trigger("changed",null,{instance:t,workflows:[]}),void 0):e._last_instance==t?(e.workflows[t.cid]&&e._trigger("changed",null,{instance:t,workflows:e.workflows[t.cid]}),void 0):(e._last_instance=t,e.workflows[t.cid]?(e._trigger("changed",null,{instance:t,workflows:e.workflows[t.cid]}),void 0):(e.options.url?e._fetchModelWorkflows(t):(flows=new(e._generateCollectionFor(t))([],{}),e._trigger("changed",null,{instance:t,workflows:flows})),void 0))},_parseRenderersAndTypes:function(){var e=this;t.each(this.options.renderers,function(t,i){e.setRenderer(t,i)}),t.each(this.options.action_types,function(t,i){e.setActionType(t,i)})},setRenderer:function(t,e){this._renderers[t]=e},getRenderer:function(t){return this._renderers[t]?this._renderers[t]:!1},setActionType:function(t,e){this._action_types[t]=e},getActionType:function(t){return this._action_types[t]},prepareItem:function(t,e,i){var o=this;return renderer=this.getRenderer(e.get("type")),action_type_cb=this.getActionType(e.get("action").type),renderer(t,e,action_type_cb,function(n,a){delete o.workflows[t.cid],o._last_instance=null,"backbone_destroy"!==e.get("action").type&&o._fetchModelWorkflows(t),i(n,a)})},_generateCollectionFor:function(t){var e={model:this.ModelWorkflowModel};return this.options.url&&(e.url=this.options.url(t)),Backbone.Collection.extend(e)},_fetchModelWorkflows:function(t){if(!t.isNew()){var e=this;e.workflows[t.cid]=new(this._generateCollectionFor(t))([],{}),e.workflows[t.cid].fetch({success:function(i){e.workflows[t.cid].reset(i.models),e._trigger("changed",null,{instance:t,workflows:e.workflows[t.cid]})},error:function(){}})}}})}(jQuery);